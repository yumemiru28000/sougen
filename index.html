<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËçâÂéü„ÅÆÂãïÁâ©„Åü„Å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background-color: #88cc88;
        }

        #background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #88cc88;
        }

        #background-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }

        #game-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .character {
            position: absolute;
            cursor: pointer;
            pointer-events: all;
            transition: transform 0.1s;
            user-select: none;
            -webkit-user-select: none;
        }

        .character img {
            width: 100%;
            height: 100%;
            display: block;
        }

        .emoji {
            position: absolute;
            font-size: 24px;
            pointer-events: none;
            z-index: 1000;
        }

        .gif-overlay {
            position: absolute;
            pointer-events: none;
            z-index: 100;
        }

        #character-counter {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 2000;
            pointer-events: none;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #overlay-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            animation: scaleIn 0.3s;
        }

        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        #overlay-content img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        #close-overlay {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background 0.2s;
        }

        #close-overlay:hover {
            transform: scale(1.1);
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div id="background-container">
        <img id="background-image" src="sibahu1.png" alt="ËçâÂéü">
    </div>
    
    <div id="game-area"></div>
    
    <div id="character-counter">0/0</div>
    
    <div id="overlay">
        <div id="overlay-content">
            <button id="close-overlay">√ó</button>
            <img id="detail-image" src="" alt="Ë©≥Á¥∞">
        </div>
    </div>

    <script>
        // „Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÂÆöÁæ©
        const characters = [
            {
                name: '„ÅÜ„Åï„Åé',
                image: 'cara1.png',
                detailImage: 'cara1.png',
                size: 25,
                emoji: ['üíï', '‚ú®', 'üíñ'],
                movementType: 3, // „Å¥„Çá„Çì„Å¥„Çá„Çì
                moveTime: 3,
                restTime: 4,
                areaType: 1, // ‰∏ãÈÉ®1/3
                affection: 2, // „Ç´„Éº„ÇΩ„É´„Å´Ëøë„Å•„Åè
                gifUrl: '', // GIF„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØURL„ÇíÊåáÂÆö
                gifDuration: 3000
            },
            {
                name: '„Å≠„Åì',
                image: 'cara2.png',
                detailImage: 'cara2.png',
                size: 20,
                emoji: ['üò∫', 'üí§', 'üêü'],
                movementType: 2, // „Åô„Éº„Å£„Å®ÁßªÂãï
                moveTime: 5,
                restTime: 6,
                areaType: 2, // ‰∏≠Â§Æ1/3
                affection: 3, // „ÇØ„É™„ÉÉ„ÇØ„ÅßÂ•ΩÊÑüÂ∫¶UP
                gifUrl: '',
                gifDuration: 2500
            },
            {
                name: '„Å≤„Å§„Åò',
                image: 'cara3.png',
                detailImage: 'cara3.png',
                size: 30,
                emoji: ['üå∏', '‚òÅÔ∏è', 'üíö'],
                movementType: 2,
                moveTime: 4,
                restTime: 5,
                areaType: 1,
                affection: 1, // „Ç´„Éº„ÇΩ„É´„Åã„ÇâÈÄÉ„Åí„Çã
                gifUrl: '',
                gifDuration: 3000
            },
            {
                name: '„Çä„Åô',
                image: 'cara4.png',
                detailImage: 'cara4.png',
                size: 15,
                emoji: ['üå∞', '‚≠ê', 'üçÇ'],
                movementType: 3,
                moveTime: 2,
                restTime: 3,
                areaType: 3, // ‰∏äÈÉ®1/3
                affection: 4, // „Å™„Åó
                gifUrl: '',
                gifDuration: 2000
            },
            {
                name: '„Åç„Å§„Å≠',
                image: 'cara5.png',
                detailImage: 'cara5.png',
                size: 28,
                emoji: ['üî•', 'üçÅ', '‚ú®'],
                movementType: 2,
                moveTime: 4,
                restTime: 4,
                areaType: 2,
                affection: 2,
                gifUrl: '',
                gifDuration: 3000
            }
        ];

        let activeCharacters = [];
        let mouseX = -1000;
        let mouseY = -1000;
        const ROTATION_INTERVAL = 300000; // 5ÂàÜ = 300000ms

        // „Éû„Ç¶„Çπ‰ΩçÁΩÆ„ÅÆËøΩË∑°
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        // „Ç≠„É£„É©„ÇØ„Çø„Éº„ÇØ„É©„Çπ
        class Character {
            constructor(data) {
                this.data = data;
                this.element = document.createElement('div');
                this.element.className = 'character';
                
                this.img = document.createElement('img');
                this.img.src = data.image;
                this.element.appendChild(this.img);
                
                const baseSize = 80;
                this.size = baseSize * (data.size / 25);
                this.element.style.width = this.size + 'px';
                this.element.style.height = this.size + 'px';
                
                this.resetPosition();
                
                this.isMoving = false;
                this.facingRight = false;
                this.affectionBoosted = false;
                this.affectionBoostTimer = null;
                
                this.setupEvents();
                this.startBehavior();
                
                if (data.gifUrl) {
                    this.startGifAnimation();
                }
                
                document.getElementById('game-area').appendChild(this.element);
            }
            
            resetPosition() {
                const area = this.getMovementArea();
                this.x = area.minX + Math.random() * (area.maxX - area.minX);
                this.y = area.minY + Math.random() * (area.maxY - area.minY);
                this.updatePosition();
            }
            
            getMovementArea() {
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                const margin = this.size;
                
                let minY, maxY;
                
                if (this.data.areaType === 1) { // ‰∏ãÈÉ®1/3
                    minY = windowHeight * 2/3;
                    maxY = windowHeight - margin;
                } else if (this.data.areaType === 2) { // ‰∏≠Â§Æ1/3
                    minY = windowHeight * 1/3;
                    maxY = windowHeight * 2/3;
                } else { // ‰∏äÈÉ®1/3
                    minY = margin;
                    maxY = windowHeight * 1/3;
                }
                
                return {
                    minX: margin,
                    maxX: windowWidth - margin,
                    minY: Math.max(minY, margin),
                    maxY: Math.min(maxY, windowHeight - margin)
                };
            }
            
            updatePosition() {
                const area = this.getMovementArea();
                
                // ÁØÑÂõ≤Â§ñ„ÉÅ„Çß„ÉÉ„ÇØ
                if (this.x < area.minX) this.x = area.minX;
                if (this.x > area.maxX) this.x = area.maxX;
                if (this.y < area.minY) this.y = area.minY;
                if (this.y > area.maxY) this.y = area.maxY;
                
                this.element.style.left = this.x + 'px';
                this.element.style.top = this.y + 'px';
            }
            
            setupEvents() {
                let clickCount = 0;
                let clickTimer = null;
                
                this.element.addEventListener('click', (e) => {
                    e.stopPropagation();
                    clickCount++;
                    
                    if (clickTimer) clearTimeout(clickTimer);
                    
                    if (clickCount === 1) {
                        clickTimer = setTimeout(() => {
                            this.onSingleClick();
                            clickCount = 0;
                        }, 300);
                    } else if (clickCount === 2) {
                        clearTimeout(clickTimer);
                        this.onDoubleClick();
                        clickCount = 0;
                    }
                });
            }
            
            onSingleClick() {
                // ÁµµÊñáÂ≠ó„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                const emojis = this.data.emoji;
                emojis.forEach((emoji, index) => {
                    setTimeout(() => {
                        this.createEmojiAnimation(emoji);
                    }, index * 300);
                });
                
                // Â•ΩÊÑüÂ∫¶„Çø„Ç§„Éó3„ÅÆÂá¶ÁêÜ
                if (this.data.affection === 3 && !this.affectionBoosted) {
                    if (Math.random() < 0.3) { // 30%„ÅÆÁ¢∫Áéá
                        this.affectionBoosted = true;
                        const duration = (5 + Math.random() * 5) * 1000;
                        
                        if (this.affectionBoostTimer) clearTimeout(this.affectionBoostTimer);
                        this.affectionBoostTimer = setTimeout(() => {
                            this.affectionBoosted = false;
                        }, duration);
                        
                        // Êéß„Åà„ÇÅ„Å™„Éè„Éº„Éà„Ç®„Éï„Çß„ÇØ„Éà
                        this.startAffectionHearts(duration);
                    }
                }
            }
            
            startAffectionHearts(duration) {
                const interval = setInterval(() => {
                    if (!this.affectionBoosted) {
                        clearInterval(interval);
                        return;
                    }
                    this.createEmojiAnimation('üíï', true);
                }, 2000);
            }
            
            onDoubleClick() {
                const overlay = document.getElementById('overlay');
                const detailImage = document.getElementById('detail-image');
                detailImage.src = this.data.detailImage;
                overlay.style.display = 'flex';
            }
            
            createEmojiAnimation(emoji, isSmall = false) {
                const emojiEl = document.createElement('div');
                emojiEl.className = 'emoji';
                emojiEl.textContent = emoji;
                emojiEl.style.left = (this.x + this.size / 2) + 'px';
                emojiEl.style.top = (this.y + this.size / 2) + 'px';
                if (isSmall) {
                    emojiEl.style.fontSize = '16px';
                    emojiEl.style.opacity = '0.7';
                }
                document.body.appendChild(emojiEl);
                
                const duration = 2000;
                const startTime = Date.now();
                const swingAmount = 30;
                
                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = elapsed / duration;
                    
                    if (progress >= 1) {
                        emojiEl.remove();
                        return;
                    }
                    
                    const x = Math.sin(progress * Math.PI * 2) * swingAmount;
                    const y = -progress * 100;
                    const opacity = 1 - progress;
                    
                    emojiEl.style.transform = `translate(${x}px, ${y}px)`;
                    emojiEl.style.opacity = opacity;
                    
                    requestAnimationFrame(animate);
                };
                
                animate();
            }
            
            startBehavior() {
                if (this.data.movementType === 1) {
                    // Âü∫Êú¨Âãï„Åã„Å™„ÅÑ
                    return;
                }
                
                this.behaviorLoop();
            }
            
            behaviorLoop() {
                const shouldMove = Math.random() < 0.5;
                
                if (shouldMove && this.data.movementType !== 1) {
                    const baseMoveTime = this.data.moveTime * 1000;
                    const moveTime = baseMoveTime * (0.7 + Math.random() * 0.6);
                    this.startMoving(moveTime);
                } else {
                    const baseRestTime = this.data.restTime * 1000;
                    const restTime = baseRestTime * (0.7 + Math.random() * 0.6);
                    setTimeout(() => this.behaviorLoop(), restTime);
                }
            }
            
            startMoving(duration) {
                this.isMoving = true;
                const startTime = Date.now();
                const area = this.getMovementArea();
                
                const targetX = area.minX + Math.random() * (area.maxX - area.minX);
                const targetY = area.minY + Math.random() * (area.maxY - area.minY);
                
                // Âêë„Åç„ÅÆË®≠ÂÆö
                if (targetX > this.x && !this.facingRight) {
                    this.facingRight = true;
                    this.element.style.transform = 'scaleX(-1)';
                } else if (targetX < this.x && this.facingRight) {
                    this.facingRight = false;
                    this.element.style.transform = 'scaleX(1)';
                }
                
                const move = () => {
                    const elapsed = Date.now() - startTime;
                    
                    if (elapsed >= duration) {
                        this.isMoving = false;
                        this.behaviorLoop();
                        return;
                    }
                    
                    // Â•ΩÊÑüÂ∫¶„ÅÆÂΩ±Èüø
                    let finalTargetX = targetX;
                    let finalTargetY = targetY;
                    
                    const currentAffection = (this.data.affection === 3 && this.affectionBoosted) ? 2 : this.data.affection;
                    
                    if (currentAffection === 1 && mouseX > 0) { // ÈÄÉ„Åí„Çã
                        const dx = this.x - mouseX;
                        const dy = this.y - mouseY;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist < 200) {
                            finalTargetX = this.x + (dx / dist) * 100 * (1 + Math.random() * 0.5);
                            finalTargetY = this.y + (dy / dist) * 100 * (1 + Math.random() * 0.5);
                        }
                    } else if (currentAffection === 2 && mouseX > 0) { // Ëøë„Å•„Åè
                        const dx = mouseX - this.x;
                        const dy = mouseY - this.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist > 100 && Math.random() < 0.3) {
                            finalTargetX = this.x + (dx / dist) * 80 * (0.8 + Math.random() * 0.4);
                            finalTargetY = this.y + (dy / dist) * 80 * (0.8 + Math.random() * 0.4);
                        }
                    }
                    
                    const progress = elapsed / duration;
                    
                    if (this.data.movementType === 2) { // „Åô„Éº„Å£„Å®ÁßªÂãï
                        this.x += (finalTargetX - this.x) * 0.02;
                        this.y += (finalTargetY - this.y) * 0.02;
                    } else if (this.data.movementType === 3) { // „Å¥„Çá„Çì„Å¥„Çá„Çì
                        const jumpInterval = 500;
                        const jumpPhase = (elapsed % jumpInterval) / jumpInterval;
                        
                        if (jumpPhase < 0.5) {
                            this.x += (finalTargetX - this.x) * 0.04;
                            this.y += (finalTargetY - this.y) * 0.04;
                            
                            const jumpHeight = Math.sin(jumpPhase * Math.PI * 2) * 15;
                            this.element.style.transform = `${this.facingRight ? 'scaleX(-1)' : ''} translateY(${jumpHeight}px)`;
                        }
                    }
                    
                    this.updatePosition();
                    requestAnimationFrame(move);
                };
                
                move();
            }
            
            startGifAnimation() {
                const animate = () => {
                    const delay = (10 + Math.random() * 20) * 1000;
                    setTimeout(() => {
                        this.showGif();
                        animate();
                    }, delay);
                };
                animate();
            }
            
            showGif() {
                if (!this.data.gifUrl) return;
                
                const gifEl = document.createElement('img');
                gifEl.className = 'gif-overlay';
                gifEl.src = this.data.gifUrl;
                gifEl.style.left = this.element.style.left;
                gifEl.style.top = this.element.style.top;
                gifEl.style.width = this.size + 'px';
                gifEl.style.height = this.size + 'px';
                
                document.getElementById('game-area').appendChild(gifEl);
                
                setTimeout(() => {
                    gifEl.remove();
                }, this.data.gifDuration);
            }
            
            destroy() {
                this.element.remove();
                if (this.affectionBoostTimer) clearTimeout(this.affectionBoostTimer);
            }
        }

        // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÈñâ„Åò„Çã
        document.getElementById('close-overlay').addEventListener('click', () => {
            document.getElementById('overlay').style.display = 'none';
        });

        document.getElementById('overlay').addEventListener('click', (e) => {
            if (e.target.id === 'overlay') {
                document.getElementById('overlay').style.display = 'none';
            }
        });

        // „Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆ„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥
        function rotateCharacters() {
            // Êó¢Â≠ò„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÂâäÈô§
            activeCharacters.forEach(char => char.destroy());
            activeCharacters = [];
            
            // „É©„É≥„ÉÄ„É†„Å´3ÂåπÈÅ∏Êäû
            const shuffled = [...characters].sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, Math.min(3, characters.length));
            
            selected.forEach(charData => {
                activeCharacters.push(new Character(charData));
            });
            
            updateCounter();
        }

        // „Ç´„Ç¶„É≥„Çø„ÉºÊõ¥Êñ∞
        function updateCounter() {
            const counter = document.getElementById('character-counter');
            counter.textContent = `${activeCharacters.length}/${characters.length}`;
        }

        // ÂàùÊúüÂåñ
        rotateCharacters();
        setInterval(rotateCharacters, ROTATION_INTERVAL);

        // „É™„Çµ„Ç§„Ç∫ÂØæÂøú
        window.addEventListener('resize', () => {
            activeCharacters.forEach(char => {
                const area = char.getMovementArea();
                if (char.x < area.minX || char.x > area.maxX || 
                    char.y < area.minY || char.y > area.maxY) {
                    char.resetPosition();
                }
            });
        });
    </script>
</body>
</html>
